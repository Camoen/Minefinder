<!doctype html>
<html>
  <head>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- TODO: Pick static version and use minified version (pixi.min.js) -->
    <script src="https://pixijs.download/release/pixi.js"></script>
  </head>
  <body>
    <div id="app">
      <v-app>
        <div class="flex-container">
          <div>
            <div v-if="modeSelected !== null" v-cloak>
              <h3>{{modeSelected}}</h3>
              <v-btn raised @click="deselectGameMode()">Back to Menu</v-btn>
            </div>
            <div v-else v-cloak>
              <h3 style="text-align:center">Select Mode</h3>
              <v-btn raised v-for="mode in gameModes" :key="mode.id" @click="selectGameMode(mode)">{{mode}}</v-btn>
            </div>
          </div>
          <div id="roomSelection" v-show="modeSelected === this.gameModes[1] && roomSelected === null">
            <div v-if="loggedIn" v-cloak>
              <h3 style="text-align:center">Hello, {{username}}!<br>Select or Create a Room<br>(TODO)</h3>
              <v-btn raised class="no-uppercase" v-for="room in roomList" :key="room.id" @click="selectRoom(room)">{{room}}</v-btn>
              <v-form v-model="roomNameForm" @submit.prevent="createRoom">
                <v-text-field 
                  label="Room Name"
                  clearable
                  placeholder="My Cool Room"
                  hint="Provide a room name to create a room."
                  :rules="[
                    v => !!v || 'Field is required',
                    v => validateRoom() || 'Room already exists'
                  ]"
                  v-model="roomName"></v-text-field>
                <v-btn
                  :disabled="!roomNameForm"
                  block
                  color="success"
                  size="large"
                  type="submit"
                  variant="elevated">Create Room</v-btn>
              </v-form>
              <v-btn
                block
                color="success"
                size="large"
                type="submit"
                variant="elevated"
                @click="logOut()">Change Username</v-btn>
            </div>
            <div v-else v-cloak>
              <v-form v-model="usernameForm" @submit.prevent="createUser">
                <v-text-field 
                  label="Username"
                  clearable
                  placeholder="Minefinder#123"
                  hint="Provide a username to join or create a room."
                  :rules="[
                    v => !!v || 'Field is required'
                  ]"
                  v-model="username"></v-text-field>
                <v-btn
                  :disabled="!usernameForm"
                  block
                  color="success"
                  size="large"
                  type="submit"
                  variant="elevated">Select Username</v-btn>
              </v-form>
            </div>
          </div>
          <div id="gameContainer" v-show="modeSelected === this.gameModes[0] || roomSelected !== null">
            <div id="game"></div>
            <v-btn
              block
              color="success"
              size="large"
              type="submit"
              variant="elevated"
              @click="leaveRoom()"
              v-show="roomSelected !== null">Leave Room</v-btn>
            </div>
          <div></div>
        </div> 
      </v-app>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
      const socket = io();
      const vuetify = new Vuetify({
        theme: {
          options: {
            customProperties: true,
          },
          themes: {
            light: {
              background: '#5f9ea0',
            },
            dark: {
              background: '#777777',
            },
          },
            dark: false,
        },
      });
      const vueApp = new Vue({
        el: '#app',
        vuetify: vuetify,

        data: {
          gameModes: ["Individual", "Multiplayer"],
          loggedIn: false,
          modeSelected: null,
          roomList: [],
          roomName: "",
          roomNameForm: false,
          roomSelected: null,
          username: null,
          usernameForm: false
        },

        created() {
          socket.on('update-room-list', (rooms) => {
            console.log("this has been called with ", rooms);
            this.roomList = rooms;
          });
        },
        methods: {
          createRoom() {
            this.roomSelected = this.roomName;
            socket.emit('room-created', this.roomSelected, this.username);
            console.log('Created room: ', this.roomSelected);
            // TODO [optional]: Don't allow a user to create a custom room, and instead manage room naming automatically
          },

          createUser() {
		  			this.loggedIn = true;
		  			socket.emit('user-created', this.username);
            console.log(this);
            // TODO: Allow identical usernames and attach a UUID, otherwise prevent duplicate usernames
		  		},

          deselectGameMode(){
            this.modeSelected = null;
            if (this.roomSelected !== null){
              this.leaveRoom();
            }
          },

          selectGameMode(mode) {
            this.modeSelected = mode;
            console.log(mode);
          },

          selectRoom(room){
            this.roomSelected = room;
            socket.emit('user-joined-room', this.roomSelected, this.username);
            console.log(this.username, 'joined ', this.roomSelected);
            // TODO: Reset game state.
          },

          leaveRoom(){
            socket.emit('user-left-room', this.roomSelected, this.username);
            this.roomSelected = null;
            // TODO: Reset game state.
          },

          logOut(){
            // TODO: Remove user from current room, if applicable
            this.loggedIn = false;
            socket.emit('user-deleted', this.username);
          },

          validateRoom(){
            // TODO: Turn roomList into a set for faster lookup.
            return !(this.roomList.includes(this.roomName));
          }
        }
      });

    </script>
    <script src="./minefinder.js"></script>
  </body>
</html>

<!-- Code borrowed from https://pixijs.io/guides/basics/getting-started.html -->